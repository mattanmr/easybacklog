#!/bin/bash
# Health Check Script for easyBacklog
# ==============================================================================
# This script verifies that all services are running correctly and accessible.
# Run this after starting Docker to ensure everything is working.
#
# Usage: ./script/healthcheck
# ==============================================================================

set -e  # Exit on any error

echo "ðŸ¥ easyBacklog Health Check"
echo "============================"
echo ""

# Colors for output
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to print success
success() {
    echo -e "${GREEN}âœ“${NC} $1"
}

# Function to print error
error() {
    echo -e "${RED}âœ—${NC} $1"
}

# Function to print warning
warning() {
    echo -e "${YELLOW}âš ${NC} $1"
}

# Function to check HTTP status
check_http_status() {
    local url=$1
    local expected=$2
    if curl -s -o /dev/null -w "%{http_code}" "$url" | grep -q "$expected"; then
        return 0
    else
        return 1
    fi
}

# Check if Docker is running
echo "Checking Docker..."
if ! docker info > /dev/null 2>&1; then
    error "Docker is not running. Please start Docker Desktop."
    exit 1
fi
success "Docker is running"
echo ""

# Check if docker-compose.yml exists
if [ ! -f docker-compose.yml ]; then
    error "docker-compose.yml not found. Are you in the right directory?"
    exit 1
fi

# Check if services are running
echo "Checking services..."
if ! docker compose ps | grep -q "Up"; then
    warning "Services are not running. Starting them now..."
    docker compose up -d
    echo "Waiting for services to start..."
    sleep 5
fi

# Check each service
SERVICES=("db" "redis" "web" "sidekiq")
for service in "${SERVICES[@]}"; do
    if docker compose ps "$service" | grep -q "Up"; then
        success "$service is running"
    else
        error "$service is not running"
        exit 1
    fi
done
echo ""

# Check PostgreSQL health
echo "Checking database..."
if docker compose exec -T db pg_isready -U postgres > /dev/null 2>&1; then
    success "PostgreSQL is accepting connections"
else
    error "PostgreSQL is not ready"
    exit 1
fi

# Check if database exists
if docker compose exec -T web bundle exec rails runner "ActiveRecord::Base.connection" > /dev/null 2>&1; then
    success "Rails can connect to database"
else
    warning "Rails cannot connect to database. You may need to run: make db-setup"
fi
echo ""

# Check Redis
echo "Checking Redis..."
if docker compose exec -T redis redis-cli ping | grep -q "PONG"; then
    success "Redis is responding"
else
    error "Redis is not responding"
    exit 1
fi
echo ""

# Check web server
echo "Checking web server..."
if check_http_status "http://localhost:3000" "200"; then
    success "Web server is responding (HTTP 200)"
    success "Application is accessible at http://localhost:3000"
else
    warning "Web server returned non-200 status. Checking if it's starting up..."
    sleep 3
    if check_http_status "http://localhost:3000" "200"; then
        success "Web server is now responding"
    else
        error "Web server is not responding correctly"
        echo "Check logs with: docker compose logs web"
    fi
fi
echo ""

# Check if database is seeded
echo "Checking database data..."
LOCALE_COUNT=$(docker compose exec -T web bundle exec rails runner "puts Locale.count" 2>/dev/null | tail -1 || echo "0")
if [ "$LOCALE_COUNT" -gt "0" ]; then
    success "Database has been seeded ($LOCALE_COUNT locales found)"
else
    warning "Database appears empty. Run: make db-setup"
fi
echo ""

# Final summary
echo "=============================="
echo "ðŸŽ‰ Health Check Complete!"
echo ""
echo "Status Summary:"
echo "  â€¢ All services: Running"
echo "  â€¢ Database: Connected"
echo "  â€¢ Redis: Connected"
echo "  â€¢ Web server: Accessible"
echo ""
echo "Access the application at: http://localhost:3000"
echo ""
echo "Useful commands:"
echo "  make logs       - View logs"
echo "  make console    - Open Rails console"
echo "  make status     - Check container status"
echo ""
