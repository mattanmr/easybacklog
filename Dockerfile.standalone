# Standalone Dockerfile for easyBacklog
# ==============================================================================
# This Dockerfile creates a self-contained image that students can build and run
# with simple commands. It includes PostgreSQL in the same container.
#
# Build: docker build -f Dockerfile.standalone -t easybacklog:latest .
# Run:   docker run -p 3000:3000 easybacklog:latest
# ==============================================================================

FROM ruby:2.6.10-bullseye

# Install all dependencies including PostgreSQL server
# Note: Debian Bullseye includes PostgreSQL 13 by default
RUN apt-get update -qq && apt-get install -y --no-install-recommends \
    postgresql \
    postgresql-client \
    postgresql-contrib \
    nodejs \
    npm \
    git \
    build-essential \
    libpq-dev \
    libxml2-dev \
    libxslt1-dev \
    zlib1g-dev \
    sudo \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Copy dependency files
COPY .ruby-version ./
COPY Gemfile Gemfile.lock ./

# Configure git and install bundler
RUN git config --global url."https://".insteadOf git://
RUN gem install bundler -v 1.17.3

# Install gems
RUN bundle install --jobs=4 --retry=3 --no-deployment

# Copy application code
COPY . .

# Copy environment configuration
RUN cp .env.example .env || true

# Create startup script
RUN cat > /app/start.sh << 'EOF'
#!/bin/bash
set -e

echo "ğŸš€ Starting easyBacklog..."

# Get PostgreSQL version
PG_VERSION=$(ls /usr/lib/postgresql/ | head -n1)
echo "ğŸ“¦ Using PostgreSQL version: $PG_VERSION"

# Initialize PostgreSQL
echo "ğŸ“¦ Initializing PostgreSQL..."
mkdir -p /var/run/postgresql
chown -R postgres:postgres /var/run/postgresql
chmod 2775 /var/run/postgresql

# Initialize database cluster if needed
PG_DATA="/var/lib/postgresql/$PG_VERSION/main"
if [ ! -d "$PG_DATA" ]; then
  mkdir -p "$PG_DATA"
  chown postgres:postgres "$PG_DATA"
  su - postgres -c "/usr/lib/postgresql/$PG_VERSION/bin/initdb -D $PG_DATA"
  
  # Configure PostgreSQL to listen on all interfaces
  echo "host all all 0.0.0.0/0 md5" >> "$PG_DATA/pg_hba.conf"
  echo "listen_addresses = '*'" >> "$PG_DATA/postgresql.conf"
fi

# Start PostgreSQL
echo "â–¶ï¸  Starting PostgreSQL..."
su - postgres -c "/usr/lib/postgresql/$PG_VERSION/bin/pg_ctl -D $PG_DATA -l /tmp/postgresql.log start"

# Wait for PostgreSQL to be ready
echo "â³ Waiting for PostgreSQL to be ready..."
for i in {1..30}; do
  if su - postgres -c "psql -U postgres -c 'SELECT 1' > /dev/null 2>&1"; then
    echo "âœ“ PostgreSQL is ready"
    break
  fi
  sleep 1
done

# Set environment variables for Rails
export DATABASE_URL="postgresql://postgres:password@localhost:5432/easybacklog_development"
export REDIS_URL="redis://localhost:6379/0"
export RAILS_ENV=development
export DB_HOST=localhost
export DB_USERNAME=postgres
export DB_PASSWORD=password

# Create and setup database
echo "ğŸ’¾ Setting up database..."
cd /app

# Create database
bundle exec rake db:create 2>/dev/null || true

# Load schema
if [ -f "db/schema.rb" ]; then
  bundle exec rake db:schema:load 2>/dev/null || bundle exec rake db:migrate
else
  bundle exec rake db:migrate
fi

# Seed database
bundle exec rake db:seed

# Load sample data if requested
if [ "$LOAD_SAMPLE_DATA" = "true" ]; then
  echo "ğŸŒ± Loading sample data..."
  bundle exec rake db:seed:sample
fi

echo ""
echo "âœ… easyBacklog is ready!"
echo ""
echo "ğŸŒ Access the application at: http://localhost:3000"
echo ""
if [ "$LOAD_SAMPLE_DATA" = "true" ]; then
  echo "ğŸ“§ Demo account credentials:"
  echo "   Email:    demo@example.com"
  echo "   Password: password123"
  echo ""
fi

# Start Rails server
echo "ğŸš€ Starting Rails server..."
bundle exec rails server -b 0.0.0.0
EOF

RUN chmod +x /app/start.sh

# Expose port
EXPOSE 3000

# Set environment variable to load sample data by default
ENV LOAD_SAMPLE_DATA=true

# Start the application
CMD ["/app/start.sh"]
